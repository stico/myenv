# (2013-12-26) Install Grapite

# One time job
sudo apt-get install libcairo2-dev
~/dev/code_src
git clone https://github.com/graphite-project/graphite-web.git graphite-web_-GIT-
cd graphite-web_-GIT-
git checkout 0.9.x

# For apache 
cd dl
wget http://modwsgi.googlecode.com/files/mod_wsgi-3.4.tar.gz
tar -zxvf mod_wsgi-3.4.tar.gz 
cd mod_wsgi-3.4/
./configure --with-apxs=/home/ouyangzhu/dev/httpd/usr/bin/apxs --with-python=/home/ouyangzhu/dev/python/bin/python && make && make install

# Update vhost file: 
#	1) all path for /opt/graphite 
#	2) #WSGISocketPrefix run/wsgi 
#	3) WSGIDaemonProcess graphite processes=5 threads=5 display-name='%{GROUP}' inactivity-timeout=120 python-path=/home/ouyangzhu/.virtualenvs/graphite/lib/python2.7/site-packages:/home/ouyangzhu/.virtualenvs/graphite/lib

# Python binary need: Sees compile script in myenv
# Virtual ENV
loadvirtualenv
#mkvirtualenv graphite
workon graphite || exit 1

# Install. Some dependency might not really needed. If install fails, just retry
#pip install pycairo # failed in virtualenv
export PYTHON=$VIRTUAL_ENV/bin/python
wget http://cairographics.org/releases/py2cairo-1.10.0.tar.bz2
tar jxvf py2cairo-1.10.0.tar.bz2
cd py2cairo-1.10.0/
./waf configure --prefix=$VIRTUAL_ENV
./waf build
./waf install
pip install django
pip install django-tagging
pip install python-memcached
#pip install Twisted, the newer version seems not play well 
pip install 'Twisted<12.0'
pip install txamqp
pip install whisper
pip install carbon --install-option="--prefix=/home/ouyangzhu/.virtualenvs/graphite" --install-option="--install-lib=/home/ouyangzhu/.virtualenvs/graphite/lib"
# python-ldap failed, but ok since it is optional
pip install python-ldap
# check if still something need to install
python ~/dev/code_src/graphite-web_-GIT-/check-dependencies.py
pip install graphite-web --install-option="--prefix=/home/ouyangzhu/.virtualenvs/graphite" --install-option="--install-lib=/home/ouyangzhu/.virtualenvs/graphite/lib"

# Config
cd ~/.virtualenvs/graphite/conf
cp carbon.conf.example carbon.conf
cp storage-schemas.conf.example storage-schemas.conf
cp graphite.wsgi.example graphite.wsgi
vi graphite.wsgi					# update the path '/opt/graphite' to '/home/ouyangzhu/.virtualenvs/graphite/webapp'
vi ~/.virtualenvs/graphite/lib/graphite/settings.py	# update SECRET_KEY = '*lk^6@0l0(iulgar$j)fbvfy&^(^u+qk3j73d18@&+ur^xuTxY'
cd ~/.virtualenvs/graphite/lib/graphite
python manage.py syncdb
# yes to create super user, 
# copy and use example-graphite-vhost.conf in apache
cd ~/.virtualenvs/graphite
./bin/carbon-cache.py start

